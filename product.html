<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Product</title>
  <meta name="description" content="Independent product reference. As an Amazon Associate, we earn from qualifying purchases." />
  <style>
    :root{--bg:#f4f4f9;--card:#fff;--border:#e5e7eb;--text:#111827;--muted:#6b7280;--primary:#111827;--soft:#f9fafb;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(90deg,#0f172a,#111827);color:#fff;padding:18px 16px;text-align:center}
    header h1{margin:0;font-size:28px;letter-spacing:.3px}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,.06);padding:14px}
    .row{display:grid;grid-template-columns:360px 1fr;gap:14px}
    @media(max-width:920px){.row{grid-template-columns:1fr}}
    .imgbox{background:var(--soft);border:1px solid var(--border);border-radius:14px;display:flex;align-items:center;justify-content:center;min-height:320px;overflow:hidden}
    .imgbox img{max-width:100%;max-height:520px;object-fit:contain}
    .meta h2{margin:0 0 8px 0;font-size:20px}
    .kv{color:var(--muted);font-size:13px;line-height:1.6}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
    .note{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.5}
    a{color:#2563eb;text-decoration:none}
  </style>
</head>
<body>
<header>
  <h1>Product Picks</h1>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div class="imgbox"><img id="img" alt="Product image" /></div>
      <div class="meta">
        <h2 id="title">Loading…</h2>
        <div class="kv" id="kv"></div>

        <div class="actions">
          <button class="btn primary" id="btnAmazon">View on Amazon</button>
          <button class="btn" id="btnBack">Back to list</button>
          <button class="btn" id="btnCopy">Copy ASIN / Market</button>
        </div>

        <div class="note">
          Affiliate disclosure: As an Amazon Associate, we earn from qualifying purchases.
          Independence: This site is not an official Amazon website and is not endorsed by Amazon.
          Purchases are completed on Amazon via the product page.
        </div>
      </div>
    </div>
  </div>
</div>

<script>

  function detectSiteBase(){
    if (location.hostname.endsWith("github.io")) {
      var seg = (location.pathname.split("/").filter(Boolean)[0] || "");
      return seg ? ("/" + seg + "/") : "/";
    }
    var baseTag = document.querySelector('base[href]');
    if (baseTag) {
      var href = baseTag.getAttribute('href') || "/";
      if (!href.startsWith("/")) href = "/" + href;
      if (!href.endsWith("/")) href += "/";
      return href;
    }
    return "/";
  }
  const SITE_BASE = detectSiteBase();


  function qs(name){
    var u = new URL(location.href);
    return u.searchParams.get(name) || "";
  }

  function stripBase(pathname){
    if (SITE_BASE !== "/" && pathname.startsWith(SITE_BASE)) {
      return "/" + pathname.slice(SITE_BASE.length);
    }
    return pathname;
  }

  function parseFromPath(){
    var p = stripBase(location.pathname || "/");
    if (p.length > 1 && p.endsWith("/")) p = p.slice(0,-1);
    var m = p.match(/^\/p\/([a-zA-Z]{2})\/([A-Za-z0-9]{10})$/);
    if (!m) return null;
    return { market: m[1].toUpperCase(), asin: m[2].toUpperCase() };
  }

  function getIdentity(){
    var market = (qs("market") || qs("m") || "").toUpperCase();
    var asin = (qs("asin") || qs("a") || "").toUpperCase();
    if (market && asin) return {market, asin};
    var fromPath = parseFromPath();
    if (fromPath) return fromPath;
    return null;
  }

  const PRODUCTS_JSON_PATH = SITE_BASE + "products.json";
  const ARCHIVE_JSON_PATH  = SITE_BASE + "archive.json";

  function normalizeMarket(x){ return (x||"").toString().trim().toUpperCase(); }
  function normalizeAsin(x){ return (x||"").toString().trim().toUpperCase(); }

  async function fetchJson(url){
    const r = await fetch(url, {cache:"no-store"});
    if (!r.ok) throw new Error(url + " -> " + r.status);
    return await r.json();
  }

  function pickLink(item){
    return item.link || item.url || item.amazon_link || item.href || "";
  }

  function pickImage(item){
    return item.image_url || item.image || item.img || item.og_image || "";
  }

  function pickTitle(item){
    return item.title || item.name || item.product_title || item.asin || "Product";
  }

  function render(item, id){
    document.title = pickTitle(item) + " • Product Picks";
    document.getElementById("title").textContent = pickTitle(item);

    const kv = document.getElementById("kv");
    const lines = [];
    lines.push("Market: " + id.market);
    lines.push("ASIN: " + id.asin);
    if (item.keyword) lines.push("Keyword: " + item.keyword);
    if (item.store) lines.push("Store: " + item.store);
    if (item.remark) lines.push("Remark: " + item.remark);
    kv.innerHTML = lines.map(x => "<div>"+x+"</div>").join("");

    const img = document.getElementById("img");
    const src = pickImage(item);
    if (src) {
      img.src = src;
      img.referrerPolicy = "no-referrer";
      img.loading = "lazy";
    } else {
      img.alt = "No image";
    }

    const link = pickLink(item);
    document.getElementById("btnAmazon").onclick = function(){
      if (!link) return alert("No link found for this item.");
      const dst = encodeURIComponent(link);
      location.href = SITE_BASE + "open.html?dst=" + dst + "&market=" + encodeURIComponent(id.market) + "&asin=" + encodeURIComponent(id.asin);
    };

    document.getElementById("btnBack").onclick = function(){
      location.href = SITE_BASE;
    };

    document.getElementById("btnCopy").onclick = async function(){
      const text = id.market + " " + id.asin;
      try {
        await navigator.clipboard.writeText(text);
      } catch(e) {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy");
        ta.remove();
      }
      alert("Copied: " + text);
    };
  }

  async function main(){
    const id = getIdentity();
    if (!id) {
      document.getElementById("title").textContent = "Invalid product URL";
      document.getElementById("kv").textContent = "Missing market/asin.";
      return;
    }

    const wantMarket = normalizeMarket(id.market);
    const wantAsin = normalizeAsin(id.asin);

    let list = [];
    try {
      list = await fetchJson(PRODUCTS_JSON_PATH);
      if (!Array.isArray(list)) list = list.products || list.items || [];
    } catch(e) {}

    if (!list || !list.length) {
      try {
        const ar = await fetchJson(ARCHIVE_JSON_PATH);
        list = Array.isArray(ar) ? ar : (ar.archive || ar.items || []);
      } catch(e) {}
    }

    const item = (list || []).find(x => normalizeMarket(x.market)===wantMarket && normalizeAsin(x.asin)===wantAsin);
    if (!item) {
      document.getElementById("title").textContent = "Product not found";
      document.getElementById("kv").innerHTML = "<div>Market: "+wantMarket+"</div><div>ASIN: "+wantAsin+"</div><div style='margin-top:6px'>No matching item in products.json / archive.json.</div>";
      document.getElementById("btnAmazon").disabled = true;
      return;
    }
    render(item, {market: wantMarket, asin: wantAsin});
  }

  main();
</script>
</body>
</html>
