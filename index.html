<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product List</title>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f9; color:#111827; }
    header { background:#111827; color:#fff; text-align:center; padding:20px 0; border-bottom:5px solid #fff; }
    header h1 { font-size:2em; font-weight:bold; margin:0 0 10px 0; }
    .country-select{
      margin:10px; font-size:1.05em; padding:6px 10px; background:#fff; color:#111827;
      border:1px solid #ddd; border-radius:6px; outline:none;
    }
    .contact-text{ font-size:1.05em; margin-top:10px; color:#fff; line-height:1.5; }
    .contact-actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:10px; padding:0 12px; }
    .contact-btn{
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px;
      background:#fff; color:#111827; text-decoration:none; border:1px solid rgba(255,255,255,.35);
      font-weight:600; font-size:14px;
    }
    .contact-btn:hover{ opacity:.92; }

    section#product-list{ max-width:1200px; margin:18px auto 30px; padding:0 12px; }
    section#product-list h2{ margin:0 0 10px 0; font-size:20px; }

    .status-bar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      padding:10px 12px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; margin-bottom:10px;
    }
    .status-left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .badge{ padding:4px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px; color:#374151; }
    .muted{ color:#6b7280; font-size:12px; }
    .hint-sub{ font-size:12px; color:#6b7280; margin-left:8px; }

    /* Notice box */
    .notice-box{
      background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin:10px 0;
    }
    .notice-head{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .notice-title{ font-weight:800; }
    .notice-body{ margin-top:10px; line-height:1.6; font-size:14px; color:#111827; }
    .notice-body ol{ margin:8px 0 10px 18px; padding:0; }
    .notice-body ul{ margin:8px 0 10px 18px; padding:0; }
    .notice-body li{ margin:6px 0; }

    .product-table-container{ width:100%; overflow-x:auto; background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
    .product-table{ width:100%; border-collapse:collapse; table-layout:auto; min-width:980px; }
    .product-table th,.product-table td{
      padding:12px; text-align:left; border-bottom:1px solid #eee; vertical-align:top;
      font-size:.9em; word-break:break-word;
    }
    .product-table th{ background:#f4f4f4; position:sticky; top:0; z-index:1; }

    .product-image{
      width:60px; height:60px; object-fit:contain; cursor:pointer; border-radius:6px;
      border:1px solid #e5e7eb; background:#fff;
    }
    .product-title{ font-weight:bold; font-size:.95em; line-height:1.35; }
    .product-link{ color:#1a73e8; text-decoration:none; font-weight:600; }
    .product-link:hover{ text-decoration:underline; }

    .btn{
      padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb;
      background:#111827; color:#fff; cursor:pointer; font-weight:600; font-size:13px; white-space:nowrap;
    }
    .btn:hover{ opacity:.92; }

    @media (max-width:768px){
      header h1{ font-size:1.5em; }
      .product-table th,.product-table td{ padding:8px; font-size:.8em; }
      .product-image{ width:50px; height:50px; }
      .product-title{ font-size:.9em; }
      .contact-text{ font-size:.95em; }
      .product-table{ min-width:920px; }
    }

    .modal{
      display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
      background:rgba(0,0,0,.7); padding-top:60px;
    }
    .modal-inner{
      width:90%; max-width:900px; margin:0 auto; position:relative; background:#fff; border-radius:14px; padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
    }
    .modal-content{
      display:block; width:100%; height:auto; max-height:78vh; object-fit:contain; border-radius:10px;
    }
    .close{
      position:absolute; top:10px; right:14px; color:#111827; font-size:26px; font-weight:bold;
      cursor:pointer; user-select:none; line-height:1;
    }
    .close:hover{ opacity:.7; }

    .empty{ padding:16px 12px; color:#6b7280; font-size:14px; }

    .remark-loading{ font-size:12px; color:#6b7280; margin-top:4px; }
  </style>
</head>

<body>
  <header>
    <h1 id="pageTitle">Product List</h1>

    <select class="country-select" id="countrySelect" onchange="onMarketChange()">
      <option value="UK">UK</option>
      <option value="US">US</option>
      <option value="DE">Germany</option>
      <option value="FR">France</option>
      <option value="IT">Italy</option>
      <option value="ES">Spain</option>
      <option value="CA">Canada</option>
      <option value="JP">Japan</option>
    </select>

    <div class="contact-text" id="contactText">
      For inquiries, you can contact us via WhatsApp, Telegram, or Email:
    </div>

    <div class="contact-actions">
      <a class="contact-btn" href="https://wa.me/8615778673666" target="_blank" rel="noopener">WhatsApp</a>
      <a class="contact-btn" href="https://t.me/dalemyrong" target="_blank" rel="noopener">Telegram</a>
      <a class="contact-btn" href="mailto:info@dalemy.top">Email</a>
    </div>
  </header>

  <section id="product-list">
    <h2 id="productsTitle">Products</h2>

    <div class="status-bar">
      <div class="status-left">
        <span class="badge" id="statusBadge">Loading…</span>
        <span class="muted" id="statusMeta"></span>
        <span class="hint-sub" id="translateHint"></span>
      </div>
      <button class="btn" onclick="fetchProductData(true)" id="refreshBtn">Refresh</button>
    </div>

    <!-- Notice Box -->
    <div class="notice-box" id="noticeBox">
      <div class="notice-head">
        <div class="notice-title" id="noticeTitle">Important Notice</div>
        <button class="btn" style="background:#374151;" id="noticeToggleBtn" onclick="toggleNotice()">Hide</button>
      </div>
      <div class="notice-body" id="noticeContent"></div>
    </div>

    <div class="product-table-container">
      <table class="product-table">
        <thead>
          <tr>
            <th id="thAction">Action</th>
            <th id="thMarket">Market</th>
            <th id="thImage">Image</th>
            <th id="thTitle">Title</th>
            <th id="thKeyword">Keyword</th>
            <th id="thStore">Store</th>
            <th id="thRemark">Remark</th>
            <th id="thPrice">Discount Price</th>
            <th id="thCommission">Commission</th>
          </tr>
        </thead>
        <tbody id="product-table-body"></tbody>
      </table>
      <div class="empty" id="emptyHint" style="display:none;">
        No products loaded. If this is your first time, run GitHub Actions once to generate products.json.
      </div>
    </div>
  </section>

  <!-- Image Modal -->
  <div id="imgModal" class="modal" onclick="closeImageModal(event)">
    <div class="modal-inner" onclick="event.stopPropagation()">
      <span class="close" onclick="closeImageModal(event)">&times;</span>
      <img class="modal-content" id="modalImg" alt="Product image">
    </div>
  </div>

  <!-- Forward Modal -->
  <div id="forwardModal" class="modal" onclick="closeForwardModal(event)">
    <div class="modal-inner" style="max-width:560px;" onclick="event.stopPropagation()">
      <span class="close" onclick="closeForwardModal(event)">&times;</span>

      <h3 style="margin:0 0 10px 0;" id="forwardTitle">Forward Product</h3>
      <div style="font-size:13px;color:#6b7280;margin-bottom:8px;" id="forwardSub">
        WhatsApp will open with the message pre-filled. You only need to press Send.
      </div>

      <div id="forwardPreview"
           style="border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#f9fafb;white-space:pre-wrap;font-size:13px;line-height:1.4;">
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;margin-top:12px;">
        <button class="btn" style="background:#374151;" onclick="copyForwardText()" id="copyBtn">Copy Text</button>
        <a class="contact-btn" id="forwardWA" href="#" target="_blank" rel="noopener">WhatsApp</a>
        <a class="contact-btn" id="forwardTG" href="#" target="_blank" rel="noopener">Telegram</a>
        <a class="contact-btn" id="forwardMail" href="#">Email</a>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const PRODUCTS_JSON_PATH = "/product-list/products.json";
    const WA_PHONE = "8615778673666";
    const TG_USERNAME = "dalemyrong";
    const EMAIL_CONTACT = "info@dalemy.top";

    // ===== State =====
    let ALL_PRODUCTS = [];
    let LAST_LOADED_AT = null;
    let CURRENT_FORWARD_PRODUCT = null;

    // ===== Language mapping =====
    const LANG_BY_MARKET = { US:"en", UK:"en", CA:"en", DE:"de", FR:"fr", IT:"it", ES:"es", JP:"ja" };

    // ===== i18n UI =====
    const UI_I18N = {
      en: {
        pageTitle: "Product List",
        productsTitle: "Products",
        contactText: "For inquiries, you can contact us via WhatsApp, Telegram, or Email:",
        refresh: "Refresh",
        translatingHint: "Remark auto-translation is enabled (Chinese only). Original will be kept if translation fails.",
        forwardTitle: "Forward Product",
        forwardSub: "WhatsApp will open with the message pre-filled. You only need to press Send.",
        copy: "Copy Text",
        th: { action:"Action", market:"Market", image:"Image", title:"Title", keyword:"Keyword", store:"Store", remark:"Remark", price:"Discount Price", commission:"Commission" },
        labels: { market:"Market", price:"Discount Price", commission:"Commission", asin:"ASIN", link:"Link", remark:"Remark" }
      },
      de: {
        pageTitle: "Produktliste",
        productsTitle: "Produkte",
        contactText: "Bei Fragen kontaktieren Sie uns über WhatsApp, Telegram oder E-Mail:",
        refresh: "Aktualisieren",
        translatingHint: "Remark wird automatisch übersetzt (nur Chinesisch). Wenn Übersetzung fehlschlägt, wird der Originaltext angezeigt.",
        forwardTitle: "Produkt weiterleiten",
        forwardSub: "WhatsApp öffnet sich mit vorbefüllter Nachricht. Sie müssen nur auf Senden tippen.",
        copy: "Text kopieren",
        th: { action:"Aktion", market:"Markt", image:"Bild", title:"Titel", keyword:"Keyword", store:"Shop", remark:"Hinweis", price:"Rabattpreis", commission:"Provision" },
        labels: { market:"Markt", price:"Rabattpreis", commission:"Provision", asin:"ASIN", link:"Link", remark:"Hinweis" }
      },
      fr: {
        pageTitle: "Liste de produits",
        productsTitle: "Produits",
        contactText: "Pour toute question, contactez-nous via WhatsApp, Telegram ou e-mail :",
        refresh: "Actualiser",
        translatingHint: "Remark est traduit automatiquement (chinois uniquement). En cas d’échec, le texte original s’affiche.",
        forwardTitle: "Transférer le produit",
        forwardSub: "WhatsApp s’ouvrira avec le message prérempli. Il ne reste qu’à envoyer.",
        copy: "Copier le texte",
        th: { action:"Action", market:"Marché", image:"Image", title:"Titre", keyword:"Mot-clé", store:"Boutique", remark:"Remarque", price:"Prix remisé", commission:"Commission" },
        labels: { market:"Marché", price:"Prix remisé", commission:"Commission", asin:"ASIN", link:"Lien", remark:"Remarque" }
      },
      it: {
        pageTitle: "Elenco prodotti",
        productsTitle: "Prodotti",
        contactText: "Per informazioni, contattaci tramite WhatsApp, Telegram o Email:",
        refresh: "Aggiorna",
        translatingHint: "Remark tradotto automaticamente (solo cinese). Se fallisce, verrà mostrato l’originale.",
        forwardTitle: "Inoltra prodotto",
        forwardSub: "WhatsApp si aprirà con il messaggio precompilato. Devi solo inviare.",
        copy: "Copia testo",
        th: { action:"Azione", market:"Mercato", image:"Immagine", title:"Titolo", keyword:"Keyword", store:"Negozio", remark:"Nota", price:"Prezzo scontato", commission:"Commissione" },
        labels: { market:"Mercato", price:"Prezzo scontato", commission:"Commissione", asin:"ASIN", link:"Link", remark:"Nota" }
      },
      es: {
        pageTitle: "Lista de productos",
        productsTitle: "Productos",
        contactText: "Para consultas, contáctanos por WhatsApp, Telegram o Email:",
        refresh: "Actualizar",
        translatingHint: "Remark se traduce automáticamente (solo chino). Si falla, se mostrará el original.",
        forwardTitle: "Reenviar producto",
        forwardSub: "WhatsApp se abrirá con el mensaje prellenado. Solo debes enviarlo.",
        copy: "Copiar texto",
        th: { action:"Acción", market:"Mercado", image:"Imagen", title:"Título", keyword:"Keyword", store:"Tienda", remark:"Nota", price:"Precio con descuento", commission:"Comisión" },
        labels: { market:"Mercado", price:"Precio con descuento", commission:"Comisión", asin:"ASIN", link:"Enlace", remark:"Nota" }
      },
      ja: {
        pageTitle: "商品リスト",
        productsTitle: "商品",
        contactText: "お問い合わせは WhatsApp / Telegram / Email からご連絡ください：",
        refresh: "更新",
        translatingHint: "Remark は自動翻訳（中国語のみ）。失敗した場合は原文を表示します。",
        forwardTitle: "商品を転送",
        forwardSub: "WhatsApp はメッセージが入力された状態で開きます。送信ボタンを押すだけです。",
        copy: "コピー",
        th: { action:"操作", market:"マーケット", image:"画像", title:"商品名", keyword:"キーワード", store:"店舗", remark:"備考", price:"割引価格", commission:"コミッション" },
        labels: { market:"マーケット", price:"割引価格", commission:"コミッション", asin:"ASIN", link:"リンク", remark:"備考" }
      }
    };

    // ===== Notice i18n =====
    const NOTICE_I18N = {
      en: {
        title: "Important Notice",
        toggleHide: "Hide",
        toggleShow: "Show",
        html: `
          <b>Shopping Process</b>
          <ol>
            <li>Select a product on this page and contact me first. I will confirm whether you can place the order.</li>
            <li>After confirmation, search the product using the <b>Keyword</b> and find it. Open the link to verify details.</li>
            <li>Verify the <b>product title</b> and <b>store name</b> are correct before ordering.</li>
            <li>After placing the order, send me the <b>order screenshot</b> for registration.</li>
            <li>Please include your <b>PayPal account</b> for refund/commission payment.</li>
            <li>After receiving the product, you can review at your own pace. When the review shows on Amazon, send me the proof/screenshot.</li>
            <li>I will report to the seller and request payment. Refund usually takes <b>3–7 days</b>.</li>
          </ol>
          <b>Remark Guide (Review Requirements)</b>
          <ul>
            <li><b>Need Text Review / Need Image Review / Need Video Review</b>: submit the review and wait until it is visible on Amazon, then send proof.</li>
            <li><b>No Review</b>: no review required. After receiving, send product photos only.</li>
            <li><b>Need Feedback</b>: leave a <b>5-star store feedback</b> (no product review required). Send screenshot.</li>
            <li><b>Need Rating</b>: leave a <b>5-star product rating</b> (no text review required). Send screenshot.</li>
          </ul>
          <b>Discount Price & Commission</b>
          <ul>
            <li><b>Discount Price = 0</b>: full refund.</li>
            <li><b>Discount Price &gt; 0</b>: you pay this amount first; it will be deducted when refunding.</li>
            <li><b>Commission</b>: extra payment after your review is confirmed.</li>
          </ul>
        `
      },
      de: {
        title: "Wichtiger Hinweis",
        toggleHide: "Ausblenden",
        toggleShow: "Anzeigen",
        html: `
          <b>Bestellablauf</b>
          <ol>
            <li>Produkt auswählen und mich zuerst kontaktieren. Ich bestätige, ob du bestellen kannst.</li>
            <li>Nach Bestätigung das Produkt über das <b>Keyword</b> suchen. Link öffnen und Details prüfen.</li>
            <li>Vor der Bestellung <b>Produkttitel</b> und <b>Shop-Name</b> prüfen.</li>
            <li>Nach der Bestellung <b>Bestell-Screenshot</b> senden (zur Registrierung).</li>
            <li>Bitte auch dein <b>PayPal-Konto</b> für Rückerstattung/Provision senden.</li>
            <li>Nach Erhalt kannst du die Bewertung frei planen. Wenn sichtbar, Screenshot/Beleg senden.</li>
            <li>Ich melde es dem Verkäufer. Rückerstattung dauert in der Regel <b>3–7 Tage</b>.</li>
          </ol>
          <b>Remark (Bewertungsanforderungen)</b>
          <ul>
            <li><b>Need Text Review / Need Image Review / Need Video Review</b>: Bewertung abgeben, bis sichtbar warten, dann Nachweis senden.</li>
            <li><b>No Review</b>: Keine Bewertung nötig. Nach Erhalt Produktfotos senden.</li>
            <li><b>Need Feedback</b>: <b>5-Sterne Shop-Feedback</b> hinterlassen (keine Produktbewertung). Screenshot senden.</li>
            <li><b>Need Rating</b>: <b>5-Sterne Produktbewertung</b> (ohne Text). Screenshot senden.</li>
          </ul>
          <b>Discount Price & Provision</b>
          <ul>
            <li><b>Rabattpreis = 0</b>: Vollständige Rückerstattung.</li>
            <li><b>Rabattpreis &gt; 0</b>: Vorab zu zahlen; wird bei der Rückerstattung abgezogen.</li>
            <li><b>Provision</b>: Zusätzliche Vergütung nach bestätigter Bewertung.</li>
          </ul>
        `
      },
      fr: {
        title: "Avis important",
        toggleHide: "Masquer",
        toggleShow: "Afficher",
        html: `
          <b>Processus d’achat</b>
          <ol>
            <li>Choisissez un produit et contactez-moi d’abord. Je confirme si vous pouvez commander.</li>
            <li>Après confirmation, recherchez via le <b>Keyword</b> et ouvrez le lien pour vérifier les détails.</li>
            <li>Vérifiez le <b>titre</b> et le <b>nom de la boutique</b> avant de commander.</li>
            <li>Après la commande, envoyez la <b>capture d’écran de la commande</b> pour l’enregistrement.</li>
            <li>Merci d’indiquer votre <b>compte PayPal</b> pour le remboursement/commission.</li>
            <li>Après réception, laissez l’avis à votre rythme. Une fois visible, envoyez la preuve.</li>
            <li>Délai de remboursement : <b>3–7 jours</b>.</li>
          </ol>
          <b>Remark (Exigences)</b>
          <ul>
            <li><b>Need Text Review / Need Image Review / Need Video Review</b> : publier l’avis, attendre qu’il soit visible, puis envoyer la preuve.</li>
            <li><b>No Review</b> : aucun avis requis. Envoyez uniquement des photos du produit.</li>
            <li><b>Need Feedback</b> : laisser un <b>feedback boutique 5 étoiles</b> (pas d’avis produit). Envoyer la capture.</li>
            <li><b>Need Rating</b> : laisser une <b>note produit 5 étoiles</b> (sans texte). Envoyer la capture.</li>
          </ul>
          <b>Discount Price & Commission</b>
          <ul>
            <li><b>Discount Price = 0</b> : remboursement intégral.</li>
            <li><b>Discount Price &gt; 0</b> : montant à payer d’abord, puis déduit lors du remboursement.</li>
            <li><b>Commission</b> : bonus après validation de l’avis.</li>
          </ul>
        `
      },
      it: {
        title: "Avviso importante",
        toggleHide: "Nascondi",
        toggleShow: "Mostra",
        html: `
          <b>Procedura di acquisto</b>
          <ol>
            <li>Seleziona un prodotto e contattami prima. Confermerò se puoi ordinare.</li>
            <li>Dopo la conferma, cerca con <b>Keyword</b> e apri il link per verificare i dettagli.</li>
            <li>Controlla <b>titolo prodotto</b> e <b>nome negozio</b> prima di ordinare.</li>
            <li>Dopo l’ordine, inviami lo <b>screenshot dell’ordine</b> per la registrazione.</li>
            <li>Includi il tuo <b>account PayPal</b> per rimborso/commissione.</li>
            <li>Dopo la consegna, puoi recensire quando vuoi. Quando visibile, inviami la prova.</li>
            <li>Rimborso in genere in <b>3–7 giorni</b>.</li>
          </ol>
          <b>Remark (Requisiti)</b>
          <ul>
            <li><b>Need Text Review / Need Image Review / Need Video Review</b>: invia la recensione, attendi la pubblicazione e poi invia la prova.</li>
            <li><b>No Review</b>: nessuna recensione. Invia solo foto del prodotto dopo la consegna.</li>
            <li><b>Need Feedback</b>: lascia <b>feedback negozio 5 stelle</b> (senza recensione prodotto). Invia screenshot.</li>
            <li><b>Need Rating</b>: lascia <b>valutazione prodotto 5 stelle</b> (senza testo). Invia screenshot.</li>
          </ul>
          <b>Discount Price & Commission</b>
          <ul>
            <li><b>Discount Price = 0</b>: rimborso totale.</li>
            <li><b>Discount Price &gt; 0</b>: importo da pagare prima; verrà detratto al rimborso.</li>
            <li><b>Commission</b>: extra dopo la conferma della recensione.</li>
          </ul>
        `
      },
      es: {
        title: "Aviso importante",
        toggleHide: "Ocultar",
        toggleShow: "Mostrar",
        html: `
          <b>Proceso de compra</b>
          <ol>
            <li>Elige un producto y contáctame primero. Confirmaré si puedes hacer el pedido.</li>
            <li>Tras la confirmación, busca con <b>Keyword</b> y abre el enlace para verificar detalles.</li>
            <li>Verifica <b>título</b> y <b>nombre de la tienda</b> antes de comprar.</li>
            <li>Después de comprar, envíame la <b>captura del pedido</b> para registrarlo.</li>
            <li>Incluye tu <b>cuenta PayPal</b> para reembolso/comisión.</li>
            <li>Tras recibir, deja la reseña cuando quieras. Cuando sea visible, envía prueba.</li>
            <li>Reembolso normalmente en <b>3–7 días</b>.</li>
          </ol>
          <b>Remark (Requisitos)</b>
          <ul>
            <li><b>Need Text Review / Need Image Review / Need Video Review</b>: publicar reseña, esperar a que aparezca y enviar prueba.</li>
            <li><b>No Review</b>: no se requiere reseña. Solo envía fotos del producto.</li>
            <li><b>Need Feedback</b>: deja <b>feedback de tienda 5 estrellas</b> (sin reseña). Envía captura.</li>
            <li><b>Need Rating</b>: deja <b>valoración 5 estrellas</b> (sin texto). Envía captura.</li>
          </ul>
          <b>Discount Price & Commission</b>
          <ul>
            <li><b>Discount Price = 0</b>: reembolso completo.</li>
            <li><b>Discount Price &gt; 0</b>: pagas este importe; se deduce en el reembolso.</li>
            <li><b>Commission</b>: pago extra tras confirmar la reseña.</li>
          </ul>
        `
      },
      ja: {
        title: "重要なお知らせ",
        toggleHide: "非表示",
        toggleShow: "表示",
        html: `
          <b>購入手順</b>
          <ol>
            <li>商品を選んだら、まず私に連絡してください。注文可能か確認します。</li>
            <li>確認後、<b>Keyword</b> で検索して商品を見つけ、リンクを開いて内容を確認してください。</li>
            <li>注文前に <b>商品名</b> と <b>店舗名</b> を必ず確認してください。</li>
            <li>注文後、登録のため <b>注文スクリーンショット</b> を送ってください。</li>
            <li>返金・報酬支払いのため <b>PayPal アカウント</b> も送ってください。</li>
            <li>到着後、レビューは自由なタイミングでOK。Amazon に表示されたら証拠（スクショ）を送ってください。</li>
            <li>返金は通常 <b>3〜7日</b> です。</li>
          </ol>
          <b>Remark（要件）</b>
          <ul>
            <li><b>Need Text Review / Need Image Review / Need Video Review</b>：レビュー投稿→表示待ち→証拠送信。</li>
            <li><b>No Review</b>：レビュー不要。到着後、商品写真のみ送信。</li>
            <li><b>Need Feedback</b>：店舗へ <b>星5のフィードバック</b>（商品レビュー不要）。スクショ送信。</li>
            <li><b>Need Rating</b>：商品へ <b>星5の評価</b>（文章不要）。スクショ送信。</li>
          </ul>
          <b>Discount Price & Commission</b>
          <ul>
            <li><b>Discount Price = 0</b>：全額返金。</li>
            <li><b>Discount Price &gt; 0</b>：先に支払い、返金時に差し引きます。</li>
            <li><b>Commission</b>：レビュー確認後に追加報酬を支払います。</li>
          </ul>
        `
      }
    };

    // ===== Currency formatting =====
    const MARKET_CURRENCY = { US:"USD", UK:"GBP", DE:"EUR", FR:"EUR", IT:"EUR", ES:"EUR", CA:"CAD", JP:"JPY" };

    function formatMoneyByMarket(value, market) {
      const currency = MARKET_CURRENCY[market] || "USD";
      const raw = String(value ?? "").trim();
      if (raw === "" || raw === null || raw === undefined) return "";
      const num = Number(raw.replace(/[^\d.-]/g, ""));
      if (!Number.isFinite(num)) return raw;

      const isJPY = currency === "JPY";
      const isInt = Math.abs(num - Math.round(num)) < 1e-9;
      const opts = {
        style:"currency",
        currency,
        minimumFractionDigits: isJPY ? 0 : (isInt ? 0 : 2),
        maximumFractionDigits: isJPY ? 0 : 2
      };
      return new Intl.NumberFormat("en", opts).format(num);
    }

    // ===== UI helpers =====
    function setStatus(text, meta = "") {
      document.getElementById("statusBadge").textContent = text;
      document.getElementById("statusMeta").textContent = meta;
    }
    function showEmptyHint(show) {
      document.getElementById("emptyHint").style.display = show ? "block" : "none";
    }
    function currentMarket() {
      return (document.getElementById("countrySelect").value || "UK").toUpperCase();
    }
    function currentLang() {
      return LANG_BY_MARKET[currentMarket()] || "en";
    }
    function tUI() {
      return UI_I18N[currentLang()] || UI_I18N.en;
    }

    function applyI18n() {
      const T = tUI();
      document.getElementById("pageTitle").textContent = T.pageTitle;
      document.getElementById("productsTitle").textContent = T.productsTitle;
      document.getElementById("contactText").textContent = T.contactText;
      document.getElementById("refreshBtn").textContent = T.refresh;
      document.getElementById("translateHint").textContent = T.translatingHint;

      document.getElementById("forwardTitle").textContent = T.forwardTitle;
      document.getElementById("forwardSub").textContent = T.forwardSub;
      document.getElementById("copyBtn").textContent = T.copy;

      document.getElementById("thAction").textContent = T.th.action;
      document.getElementById("thMarket").textContent = T.th.market;
      document.getElementById("thImage").textContent = T.th.image;
      document.getElementById("thTitle").textContent = T.th.title;
      document.getElementById("thKeyword").textContent = T.th.keyword;
      document.getElementById("thStore").textContent = T.th.store;
      document.getElementById("thRemark").textContent = T.th.remark;
      document.getElementById("thPrice").textContent = T.th.price;
      document.getElementById("thCommission").textContent = T.th.commission;

      renderNotice();
    }

    // ===== Notice functions =====
    function renderNotice() {
      const lang = currentLang();
      const N = NOTICE_I18N[lang] || NOTICE_I18N.en;

      const titleEl = document.getElementById("noticeTitle");
      const contentEl = document.getElementById("noticeContent");
      const btnEl = document.getElementById("noticeToggleBtn");
      if (!titleEl || !contentEl || !btnEl) return;

      titleEl.textContent = N.title;

      const hidden = localStorage.getItem("notice_hidden") === "1";
      contentEl.innerHTML = N.html;
      contentEl.style.display = hidden ? "none" : "block";
      btnEl.textContent = hidden ? N.toggleShow : N.toggleHide;
    }

    function toggleNotice() {
      const contentEl = document.getElementById("noticeContent");
      const lang = currentLang();
      const N = NOTICE_I18N[lang] || NOTICE_I18N.en;

      const isHidden = contentEl.style.display === "none";
      contentEl.style.display = isHidden ? "block" : "none";
      localStorage.setItem("notice_hidden", isHidden ? "0" : "1");

      const btnEl = document.getElementById("noticeToggleBtn");
      btnEl.textContent = isHidden ? N.toggleHide : N.toggleShow;
    }

    // ===== Translation (Remark only, Chinese only) =====
    const TRANSLATE_CACHE_KEY = "remark_translate_cache_v2";
    const translateCache = loadCache();

    function loadCache() {
      try { return JSON.parse(localStorage.getItem(TRANSLATE_CACHE_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveCache() {
      try { localStorage.setItem(TRANSLATE_CACHE_KEY, JSON.stringify(translateCache)); } catch {}
    }
    function cacheKey(lang, text) {
      return lang + "||" + text;
    }

    function hasChinese(text) {
      return /[\u4e00-\u9fff]/.test(text || "");
    }

    // 任何看起来像“错误提示/说明文字”的翻译结果都当作失败
    function isBadTranslation(out) {
      const sRaw = (out || "").toString().trim();
      if (!sRaw) return true;

      const s = sRaw.toUpperCase();
      if (s.includes("INVALID")) return true;
      if (s.includes("ERROR")) return true;
      if (s.includes("LANGPAIR")) return true;
      if (s.includes("RFC3066")) return true;
      if (s.includes("SUPPORTED")) return true;
      if (s.includes("EXAMPLE:")) return true;
      if (s.startsWith("'AUTO'")) return true;
      if (s.startsWith("AUTO ")) return true;
      return false;
    }

    function purgeBadCacheEntries() {
      let changed = false;
      for (const k of Object.keys(translateCache)) {
        if (isBadTranslation(translateCache[k])) {
          delete translateCache[k];
          changed = true;
        }
      }
      if (changed) saveCache();
    }

    // LibreTranslate public instances (availability may vary)
    const LIBRE_INSTANCES = [
      "https://libretranslate.de/translate",
      "https://translate.terraprint.co/translate",
      "https://lt.vern.cc/translate"
    ];

    async function libreTranslateOnce(endpoint, q, targetLang) {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          q,
          source: "zh",
          target: targetLang,
          format: "text"
        })
      });
      if (!res.ok) throw new Error("translate http " + res.status);
      const data = await res.json();
      const out = (data && (data.translatedText || data.translation))
        ? String(data.translatedText || data.translation).trim()
        : "";
      return out;
    }

    async function translateRemark(text, targetLang) {
      const q = (text || "").trim();
      if (!q) return "";
      if (!hasChinese(q)) return q;
      if (targetLang === "en") return q;

      const key = cacheKey(targetLang, q);

      // 缓存里若是坏数据，直接删掉并回退原文
      if (translateCache[key] && isBadTranslation(translateCache[key])) {
        delete translateCache[key];
        saveCache();
        return q;
      }
      if (translateCache[key]) return translateCache[key];

      for (const ep of LIBRE_INSTANCES) {
        try {
          const out = await libreTranslateOnce(ep, q, targetLang);
          // 任何失败/无效输出都回退原文
          if (!out || out === q || isBadTranslation(out)) continue;

          translateCache[key] = out;
          saveCache();
          return out;
        } catch (e) {
          // try next endpoint
        }
      }
      return q;
    }

    // queue (avoid burst)
    let translateQueue = [];
    let translating = false;

    function enqueueTranslate(task) {
      translateQueue.push(task);
      if (!translating) runTranslateQueue();
    }
    async function runTranslateQueue() {
      translating = true;
      while (translateQueue.length) {
        const task = translateQueue.shift();
        try { await task(); } catch {}
        await sleep(220);
      }
      translating = false;
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    async function translateVisibleRemarks() {
      const lang = currentLang();

      const visibleRows = Array.from(document.querySelectorAll(".product-row"))
        .filter(r => r.style.display !== "none");

      visibleRows.forEach(row => {
        const remarkEl = row.querySelector(".remark-text");
        const loadingEl = row.querySelector(".remark-loading");
        if (!remarkEl) return;

        const orig = (remarkEl.dataset.remarkOriginal || "").trim();
        if (!orig) return;

        // 不含中文或英文市场：直接原文
        if (!hasChinese(orig) || lang === "en") {
          remarkEl.textContent = orig;
          remarkEl.title = orig;
          if (loadingEl) loadingEl.textContent = "";
          return;
        }

        const key = cacheKey(lang, orig);
        if (translateCache[key] && !isBadTranslation(translateCache[key])) {
          remarkEl.textContent = translateCache[key];
          remarkEl.title = orig;
          if (loadingEl) loadingEl.textContent = "";
          return;
        }

        // 翻译中提示（可选：你不想显示也可以置空）
        if (loadingEl) loadingEl.textContent = "Translating…";
        remarkEl.textContent = orig;
        remarkEl.title = orig;

        enqueueTranslate(async () => {
          const out = await translateRemark(orig, lang);
          // out 可能是原文（失败回退）
          remarkEl.textContent = out || orig;
          remarkEl.title = orig;
          if (loadingEl) loadingEl.textContent = "";
        });
      });
    }

    // ===== Fetch JSON =====
    function fetchProductData(manual = false) {
      const url = PRODUCTS_JSON_PATH + "?ts=" + Date.now();
      setStatus(manual ? "Refreshing…" : "Loading…", "Fetching products.json");

      fetch(url, { cache: "no-store" })
        .then(res => {
          if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
          return res.json();
        })
        .then(products => {
          if (!Array.isArray(products)) throw new Error("products.json is not an array");

          ALL_PRODUCTS = products;
          LAST_LOADED_AT = new Date();

          displayProducts(ALL_PRODUCTS);
          filterProductsByCountry();
          applyI18n();
          translateVisibleRemarks();

          setStatus("Loaded", `${products.length} items · ${LAST_LOADED_AT.toLocaleString()}`);
          showEmptyHint(products.length === 0);
        })
        .catch(err => {
          console.error("Failed to load products.json:", err);
          setStatus("Load failed", err.message);
          showEmptyHint(true);
          if (manual) alert("Failed to load products.json.\n\n" + err.message);
        });
    }

    // ===== Render =====
    function displayProducts(products) {
      const tbody = document.getElementById("product-table-body");
      tbody.innerHTML = "";

      products.forEach(product => {
        const row = document.createElement("tr");
        row.classList.add("product-row");
        const market = (product.market || "").trim().toUpperCase();
        row.setAttribute("data-market", market);

        const safeTitle = escapeHtml(product.title || "");
        const safeKeyword = escapeHtml(product.keyword || "");
        const safeStore = escapeHtml(product.store || "");
        const origRemark = String(product.remark || "");
        const link = (product.link || "").trim();
        const img = (product.image_url || "").trim();

        const priceFormatted = formatMoneyByMarket(product.price, market);
        const commissionFormatted = formatMoneyByMarket(product.commission, market);

        row.innerHTML = `
          <td>
            <button class="btn" onclick='openForwardModal(${encodeProductForOnclick(product)})'>Forward</button>
          </td>
          <td>${escapeHtml(market)}</td>
          <td>
            ${img ? `
              <img src="${escapeAttr(img)}" alt="${safeTitle}" class="product-image"
                   onclick="openImageModal('${escapeAttr(img)}')" />
            ` : ""}
            ${link ? `<div style="margin-top:6px;"><a class="product-link" href="${escapeAttr(link)}"
                   target="_blank" rel="noopener">Open</a></div>` : ""}
          </td>
          <td class="product-title">${safeTitle}</td>
          <td style="cursor:pointer;" title="Click to copy"
              onclick="copyToClipboard('${escapeAttr(product.keyword || "")}')">${safeKeyword}</td>
          <td>${safeStore}</td>
          <td>
            <div class="remark-text" data-remark-original="${escapeAttr(origRemark)}" title="${escapeAttr(origRemark)}">${escapeHtml(origRemark)}</div>
            <div class="remark-loading"></div>
          </td>
          <td>${escapeHtml(priceFormatted)}</td>
          <td>${escapeHtml(commissionFormatted)}</td>
        `;
        tbody.appendChild(row);
      });

      showEmptyHint(products.length === 0);
    }

    function encodeProductForOnclick(product) {
      const safe = {
        market: product.market || "",
        asin: product.asin || "",
        title: product.title || "",
        keyword: product.keyword || "",
        store: product.store || "",
        remark: product.remark || "",
        link: product.link || "",
        image_url: product.image_url || "",
        price: product.price || "",
        commission: product.commission || "",
        status: product.status || ""
      };
      return JSON.stringify(safe)
        .replaceAll("&", "\\u0026")
        .replaceAll("<", "\\u003c")
        .replaceAll(">", "\\u003e");
    }

    // ===== Filter =====
    function filterProductsByCountry() {
      const selectedCountry = currentMarket();
      const rows = document.querySelectorAll(".product-row");

      let visibleCount = 0;
      rows.forEach(row => {
        const market = row.getAttribute("data-market");
        if (market === selectedCountry) {
          row.style.display = "";
          visibleCount++;
        } else {
          row.style.display = "none";
        }
      });

      localStorage.setItem("selectedCountry", selectedCountry);

      if (LAST_LOADED_AT) {
        setStatus("Loaded", `${visibleCount}/${ALL_PRODUCTS.length} visible · ${LAST_LOADED_AT.toLocaleString()}`);
      }
    }

    function onMarketChange() {
      filterProductsByCountry();
      applyI18n();
      translateVisibleRemarks();
    }

    // ===== Copy =====
    function copyToClipboard(text) {
      if (!text) return;
      copyText(text).then(() => alert("Copied!")).catch(() => alert("Copy failed"));
    }

    function copyText(text) {
      if (navigator.clipboard && window.isSecureContext) return navigator.clipboard.writeText(text);
      return new Promise((resolve, reject) => {
        try {
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          resolve();
        } catch (e) { reject(e); }
      });
    }

    // ===== Image Modal =====
    function openImageModal(imgUrl) {
      document.getElementById("modalImg").src = imgUrl;
      document.getElementById("imgModal").style.display = "block";
    }
    function closeImageModal(e) {
      document.getElementById("imgModal").style.display = "none";
      document.getElementById("modalImg").src = "";
    }

    // ===== Forward Modal =====
    async function openForwardModal(product) {
      CURRENT_FORWARD_PRODUCT = product;

      const market = (product.market || "").trim().toUpperCase();
      const lang = LANG_BY_MARKET[market] || "en";
      const T = UI_I18N[lang] || UI_I18N.en;

      // Remark：若中文则翻译，否则原文；翻译失败默认原文
      const remarkOrig = String(product.remark || "").trim();
      let remarkDisplay = remarkOrig;
      if (remarkOrig && hasChinese(remarkOrig) && lang !== "en") {
        const out = await translateRemark(remarkOrig, lang);
        // out 若为坏翻译则回退原文（translateRemark 已保证，但这里再兜底一次）
        remarkDisplay = (!out || isBadTranslation(out)) ? remarkOrig : out;
      }

      const text = buildForwardTextLocalized(product, T.labels, market, remarkDisplay);
      document.getElementById("forwardPreview").textContent = text;

      // WhatsApp：phone + text 预填
      const waUrl = "https://wa.me/" + WA_PHONE + "?text=" + encodeURIComponent(text);
      document.getElementById("forwardWA").href = waUrl;

      // Telegram：最稳定方式 = 先复制文案，再打开你的私聊链接
      const tgBtn = document.getElementById("forwardTG");
      tgBtn.href = "https://t.me/" + TG_USERNAME;
      tgBtn.onclick = (e) => {
        e.preventDefault();
        copyText(text)
          .then(() => window.open("https://t.me/" + TG_USERNAME, "_blank"))
          .catch(() => window.open("https://t.me/" + TG_USERNAME, "_blank"));
      };

      // Email：mailto 预填
      const subject = `[${market}] ${product.title || "Product"}`.trim();
      document.getElementById("forwardMail").href =
        "mailto:" + encodeURIComponent(EMAIL_CONTACT) +
        "?subject=" + encodeURIComponent(subject) +
        "&body=" + encodeURIComponent(text);

      // forward UI i18n
      document.getElementById("forwardTitle").textContent = T.forwardTitle;
      document.getElementById("forwardSub").textContent = T.forwardSub;
      document.getElementById("copyBtn").textContent = T.copy;

      document.getElementById("forwardModal").style.display = "block";
    }

    function closeForwardModal(e) {
      document.getElementById("forwardModal").style.display = "none";
      CURRENT_FORWARD_PRODUCT = null;
    }

    function buildForwardTextLocalized(p, labels, market, remarkDisplay) {
      const price = formatMoneyByMarket(p.price, market);
      const commission = formatMoneyByMarket(p.commission, market);

      const lines = [];
      if (p.title) lines.push(p.title);

      lines.push(`${labels.market}: ${market || "-"}`);

      // 注意：0 也要显示（你说 Discount Price=0 表示全额返款）
      const rawPrice = String(p.price ?? "").trim();
      if (rawPrice !== "") lines.push(`${labels.price}: ${price || rawPrice}`);

      const rawCommission = String(p.commission ?? "").trim();
      if (rawCommission !== "") lines.push(`${labels.commission}: ${commission || rawCommission}`);

      if (p.asin) lines.push(`${labels.asin}: ${p.asin}`);
      if (p.link) lines.push(`${labels.link}: ${p.link}`);
      if (remarkDisplay) lines.push(`${labels.remark}: ${remarkDisplay}`);
      return lines.join("\n");
    }

    function copyForwardText() {
      const text = document.getElementById("forwardPreview").textContent || "";
      if (!text) return;
      copyText(text).then(() => alert("Copied!")).catch(() => alert("Copy failed"));
    }

    // ===== XSS safety =====
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function escapeAttr(str) { return escapeHtml(str); }

    // ===== Init =====
    window.onload = function () {
      purgeBadCacheEntries();

      const savedCountry = localStorage.getItem("selectedCountry");
      document.getElementById("countrySelect").value = savedCountry || "UK";

      applyI18n();
      fetchProductData(false);

      setInterval(() => fetchProductData(false), 15 * 60 * 1000);
    };
  </script>
</body>
</html>
